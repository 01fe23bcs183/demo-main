generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ORGANIZER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
  ATTENDED
  NO_SHOW
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
  SOLD_OUT
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  phone         String?
  name          String
  passwordHash  String
  role          UserRole @default(CUSTOMER)
  twoFactor     Boolean  @default(false)
  karmaPoints   Int      @default(0)
  organizer     Organizer?
  bookings      Booking[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Organizer {
  id               String   @id @default(cuid())
  user             User     @relation(fields: [userId], references: [id])
  userId           String   @unique
  businessName     String
  gstin            String?
  pan              String?
  bankAccount      String?
  ifsc             String?
  isVerified       Boolean  @default(false)
  logo             String?
  website          String?
  description      String?
  commissionOverride Float?
  events           Event[]
  payouts          Payout[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Event {
  id                  String   @id @default(cuid())
  title               String
  slug                String   @unique
  description         String
  category            String
  coverImage          String?
  venue               String
  address             String?
  city                String
  state               String?
  latitude            Float?
  longitude           Float?
  startTime           DateTime
  endTime             DateTime?
  timeZone            String   @default("Asia/Kolkata")
  price               Int
  totalSeats          Int
  bookedSeats         Int      @default(0)
  maxBookingPerUser   Int      @default(10)
  allowCancellation   Boolean  @default(true)
  cancellationWindowHrs Int    @default(6)
  status              EventStatus @default(DRAFT)
  tags                String[]
  seoMeta             String?
  organizer           Organizer @relation(fields: [organizerId], references: [id])
  organizerId         String
  bookings            Booking[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Booking {
  id                 String   @id @default(cuid())
  ticketNumber       String   @unique
  qrCode             String?
  seats              Int
  ticketPrice        Int
  paymentGatewayFee  Int
  serverMaintenanceFee Int
  platformFixedFee   Int
  platformPercentFee Int
  finalAmount        Int
  paymentOrderId     String?
  paymentId          String?
  paymentStatus      String?
  status             BookingStatus @default(PENDING)
  userSnapshotName   String
  userSnapshotEmail  String
  userSnapshotPhone  String?
  cancellationReason String?
  cancelledAt        DateTime?
  attendedAt         DateTime?
  user               User    @relation(fields: [userId], references: [id])
  userId             String
  event              Event   @relation(fields: [eventId], references: [id])
  eventId            String
  createdAt          DateTime @default(now())
}

model Payout {
  id            String   @id @default(cuid())
  organizer     Organizer @relation(fields: [organizerId], references: [id])
  organizerId   String
  amount        Int
  periodStart   DateTime
  periodEnd     DateTime
  status        PayoutStatus @default(PENDING)
  transactionId String?
  utr           String?
  failureReason String?
  createdAt     DateTime @default(now())
}
